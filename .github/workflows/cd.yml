name: Deploy to Azure VM

on:
  workflow_run:
    workflows:
      - Quality Control (Jest)
    types:
      - completed

jobs:
  deploy:
    name: Deploy Docker Image via SSH
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'feat/add-programs-api'
    runs-on: ubuntu-latest

    steps:
      - name: Set up SSH key
        run: |
          echo "${{ secrets.VM_SSH_KEY }}" > private_key.pem
          chmod 400 private_key.pem

      - name: Deploy on Azure VM
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key.pem \
          ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'EOF'

            set -e

            if ! command -v docker &> /dev/null; then
              sudo apt-get update -y
              sudo apt-get install -y docker.io
              sudo systemctl start docker
              sudo systemctl enable docker
            fi

            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/digital-pause-backend:latest

            sudo docker stop digital-pause-backend || true
            sudo docker rm digital-pause-backend || true

            sudo docker run -d \
              --name digital-pause-backend \
              -p 3000:3000 \
              -e NODE_ENV=production \
              -e DB_HOST=${{ secrets.DB_HOST }} \
              -e DB_PORT=${{ secrets.DB_PORT }} \
              -e DB_USER=${{ secrets.DB_USER }} \
              -e DB_PASS=${{ secrets.DB_PASS }} \
              -e DB_NAME=${{ secrets.DB_NAME }} \
              -e DB_SSL=${{ secrets.DB_SSL }} \
              ${{ secrets.DOCKER_USERNAME }}/digital-pause-backend:latest

            sudo docker image prune -f

          EOF